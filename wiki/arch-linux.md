+++
title = 'Arch Linux'
categories = ['linux']
aliases = ['arch_linux']
publishDate = '2024-03-28T16:43:56Z'
lastmod = '2024-04-02T18:45:14Z'
summary = """Простой, легковесный и гибкий дистрибутив GNU/Linux. \
Программы в нём обновляются постоянно — пользователи получают новейшие версии. \
Изначально в Arch не установлено никаких программ, кроме ядра и основных \
инструментов. Необходимо проводить ручную установку в терминале, но есть и \
автоматический текстовый установщик."""
cover = '/media/arch_linux.webp'
+++

# Arch Linux
{{< categories >}}

[Arch Linux](https://archlinux.org) — простой, легковесный и гибкий дистрибутив
GNU/Linux. Программы в нём обновляются постоянно — пользователи получают
новейшие версии. Изначально в Arch не установлено никаких программ, кроме ядра
и основных инструментов. Необходимо проводить ручную установку в терминале, но
есть и автоматический текстовый установщик.

В основе Arch лежит принцип "сделай сам" (Do It Yourself). Если вы собираетесь
установить и пользоваться Arch Linux или его производными, предполагается
следующее:

- Вы готовы к неожиданному поведению после обновлений или изменений конфигураций
- У вас имеются резервные копии данных, снимки системы и USB-накопитель с
Live-окружением для восстановления
- Вы готовы регулярно проводить обслуживание системы
- Вы готовы самостоятельно находить решения проблем в интернете и изучать
официальные руководства

Если вышесказанное относится к вам, то у вас должна получиться стабильная
система, которой будет приятно пользоваться.

> **Смотрите также:**
[Часто задаваемые вопросы — ArchWiki](https://wiki.archlinux.org/title/Frequently_asked_questions_(Русский))
{.related}

## Производные

> **Смотрите также:**
[Дистрибутивы, основанные на Arch — ArchWiki](https://wiki.archlinux.org/title/Arch-based_distributions_(Русский))
{.related}

{{< blockquote >}}
> [!important]
> Все официальные и большинство сторонних ресурсов про Arch Linux, включая эту
страницу, не предусматривают применение на производных дистрибутивах. Вы **не**
используете Arch Linux, если пользуетесь его производными, однако вам тоже
необходимо уделять время обслуживанию системы.
{{< /blockquote >}}

### EndeavourOS

[EndeavourOS](https://endeavouros.com) предоставляет возможность установить Arch
без хлопот. Имеет графический установщик, в котором можно выбрать
устанавливаемое программное обеспечение, а также собственное оформление
внешнего вида. Используются официальные репозитории Arch, а также собственный
репозиторий с дополнительными программами.

Этот дистрибутив самый простой и наиболее близкий к Arch. Отлично подходит для
первого знакомства с ним.

### Manjaro

[Manjaro](https://manjaro.org) нацелен на простую установку, стабильность и
поддержку. Имеет графический установщик, несколько вариантов оболочек и
предустановленное оформление внешнего вида.

Manjaro использует свои репозитории, в которых обновления откладываются на
несколько недель в целях дополнительного тестирования. Некоторые считают это
бессмысленным, ведь обновления в Arch также тестируются перед выпуском в
стабильную ветку. Это дополнительный период ожидания перед получением новых
функций, исправлений ошибок и патчей безопасности. К тому же это может сломать
некоторые пакеты из пользовательского репозитория (AUR), если они зависят от
более новых версий библиотек.

Также Manjaro [известен проблемами](https://manjarno.pages.dev), которые
периодически происходили в прошлом. Не один раз забывали продлевать
сертификаты, вызывали DDoS-атаку на AUR.

## Подготовка установочного носителя

Установочный носитель предназначен только для новых установок или
восстановления. Существующую систему Arch Linux всегда можно обновить командой
`pacman -Syu`.

Скачайте установочный файл с
[официального сайта](https://archlinux.org/download). Рекомендуется скачивать
через BitTorrent — так обычно быстрее, и выполняется проверка на целостность.
Если вы скачиваете с зеркала, то стоит
[проверить подлинность файла](https://wiki.archlinux.org/title/Installation_guide_(Русский)#Проверка_подписи).
Установочный образ с самым свежим программным обеспечением выходит каждое начало
месяца.

Скачанный ISO-файл нужно записать на
[USB-накопитель](https://wiki.archlinux.org/title/USB_flash_installation_medium_(Русский))
при помощи [balenaEtcher](https://etcher.balena.io) или
[Rufus](https://rufus.ie). Также можно воспользоваться
[Ventoy](https://www.ventoy.net), чтобы иметь возможность загружаться с ISO
напрямую, не перезаписывая USB-накопитель.

{{< blockquote >}}
> [!warning]
> Установка операционной системы потенциально ведёт к потере данных.
Подразумевается, что у вас уже есть актуальная и рабочая резервная копия всех
важных данных.
{{< /blockquote >}}

Установочный образ не поддерживает
[Secure Boot](https://wiki.archlinux.org/title/Unified_Extensible_Firmware_Interface/Secure_Boot)
и режим [RAID](https://wiki.archlinux.org/title/RAID). Во время установки это
можно будет настроить, но пока отключите эти настройки в BIOS/UEFI.

При успешной загрузке с установочного устройства должен отобразиться терминал с
приветственным сообщением. Переключаться между сеансами терминала можно
сочетанием `Ctrl`+`Alt`+`[F1-F9]` (логин: root).

![Live-сеанс Arch Linux. Отображается приветственное сообщение и доступен терминал для ввода команд.](/media/arch_linux_live_session.webp)

Вы можете выбрать русскую раскладку клавиатуры командой `loadkeys ru`, а затем
переключаться при помощи сочетания клавиш `Ctrl`+`Shift`. Загрузить символы
кириллицы командой `setfont cyr-sun16`.

Для установки системы требуется соединение с интернетом. Подключиться к Wi-Fi
можно при помощи [iwctl](https://wiki.archlinux.org/title/Iwd_(Русский)#iwctl).
Проверить соединение: `ping -c 5 archlinux.org`.

## Двойная загрузка с Windows

> **Основная статья:**
[Dual boot with Windows — ArchWiki](https://wiki.archlinux.org/title/Dual_boot_with_Windows)
{.related}

{{< blockquote >}}
> [!caution]
> Этот раздел не был надёжно проверен и может содержать неточности и неполную
информацию. Рекомендуется исследовать другие ресурсы.
{{< /blockquote >}}

{{< blockquote >}}
> [!note]
> Информация в этом разделе актуальна только для режима загрузки UEFI.
{{< /blockquote >}}

Сначала следует установить Windows, так как она может стереть загрузчик
Linux. Загрузчик Windows можно скопировать на другой носитель, а затем после
установки загрузчика Linux восстановить его на новом разделе. Systemd-boot умеет
находить загрузчик Windows автоматически по пути
`/EFI/Microsoft/Boot/Bootmgfw.efi`. Обратите внимание, что раздел загрузчика
Windows может иметь слишком маленький размер, которого не хватит для Linux. У
вас должен быть только один раздел UEFI на компьютере.

Автоматические установщики должны уметь определять наличие установленной
системы Windows и настраивать двойную загрузку.

## Автоматическая установка

[Archinstall](https://wiki.archlinux.org/title/Archinstall) — автоматический
пошаговый установщик с текстовым интерфейсом. Вы можете использовать его для
лёгкой и быстрой установки системы. Доступен экспорт конфигурации установки.

![Archinstall](/media/arch_linux_archinstall.webp)

Подключитесь к сети, а затем введите `archinstall`. Если обнаружена новая
версия, обновите при помощи `pacman -S archinstall`. Выбирайте желаемые
опции или оставляйте умолчания/оптимальные. После успешной установки можно
использовать chroot для завершения настройки.

Система, установленная при помощи Archinstall, может быть даже стабильнее
установленной вручную. Но иногда с установщиком могут возникнуть проблемы. В
таком случае вам нужно
[найти решение](https://github.com/archlinux/archinstall/issues?q=is%3Aissue).
Установщик [написан на языке Python](https://github.com/archlinux/archinstall),
может потребоваться изменить код для исправления ошибок.

Archinstall производит установку системы не совсем так, как это делают вручную.
При обращении за помощью необходимо прикладывать журнал установщика
(`/var/log/archinstall/install.log`).

> **Смотрите также:**
[Документация Archinstall](https://archinstall.archlinux.page) (англ.)
{.related}

## Ручная установка

Во время ручной установки вы **всегда** должны опираться на
[официальную инструкцию](https://wiki.archlinux.org/title/Installation_guide_(Русский)),
[ArchWiki](https://wiki.archlinux.org/title/Main_page_(Русский)) и руководства
команд ([Manual pages](https://man.archlinux.org)). За пределами
официальных ресурсов нет никакой гарантии.

Этот раздел **не является** полным руководством, здесь лишь содержатся
объяснения и дополнения к некоторым моментам во время ручной установки.
Информация, приведённая на этой странице, может быть уже
**устаревшей или недействительной**. Вы **всегда** должны сверяться с
официальными ресурсами, прежде чем выполнять какие-либо действия.

Ручная установка на самом деле не такая сложная, как может показаться. В
процессе такой установки можно узнать, как устроена работа Unix-подобных систем
и компьютеров в целом.

Ручная установка в целом не имеет определённого порядка. В разных источниках
процесс может незначительно отличаться. Этапы установки зависят от выбранного
программного обеспечения и оборудования.

Информация на этой странице актуальна только для режима загрузки UEFI. Проверьте
при помощи `cat /sys/firmware/efi/fw_platform_size`.

### Диски

Используйте `lsblk` или `fdisk -l` для получения списка дисков и разделов.
Определите диск, на который вы собираетесь установить систему. Если желаемый
диск не отображается, отключите режим RAID в BIOS/UEFI.

{{< blockquote >}}
> [!warning]
> Выполнение операций над дисками и разделами может привести к потере данных. У
вас всегда должна быть актуальная резервная копия. Запускайте все команды
осторожно.
{{< /blockquote >}}

#### Разметка

Очистить диск можно командой `gdisk` -> `x` -> `z` (разметка GPT). Разбить диск
на разделы можно командой `cgdisk`.

Для установки системы нужен как минимум один корневой раздел и раздел EFI в
режиме UEFI.

1. **boot** (`ef00`): 1GiB
    - Раздел загрузчика EFI.
2. **swap** (`8200`): Половина ОЗУ (не больше 16 GiB)
    - Раздел [подкачки](https://wiki.archlinux.org/title/Swap_(Русский)), куда
    будут выгружаться данные из оперативной памяти в случае необходимости.
3. **root** (`8300`): 80 GiB (на усмотрение)
    - Корневой раздел, где будут храниться все программы, библиотеки, журнал и
    конфигурация.
4. **home** (`8300`): Остаток
    - Вы можете создать раздел, где будут храниться данные пользователя отдельно
    от системы. В таком случае можно будет переустановить систему (в том числе
    сменить дистрибутив), не затрагивая данных пользователей.

Далее на этой странице будем считать раздел boot как `/dev/sda1`,
swap — `/dev/sda2`, root — `/dev/sda3`, home — `/dev/sda4`.

#### Форматирование

```sh
# Boot
mkfs.fat -n BOOT -F 32 /dev/sda1

# Swap
mkswap /dev/sda2
swapon /dev/sda2

# Остальные
mkfs.btrfs -L root /dev/sda3
mkfs.btrfs -L home /dev/sda4
```

[Файловая система Btrfs](https://wiki.archlinux.org/title/Btrfs_(Русский))
является наиболее современной. Она позволяет делать моментальные снимки системы,
которые не занимают много места.

Для Btrfs требуется немного больше знаний. Если вы не готовы, то будет
достаточно файловой системы ext4. Тогда нужно использовать соответствующую
команду `mkfs.ext4`.

{{< blockquote >}}
> [!note]
> **Подробнее про Btrfs:**
> - [https://christitus.com/btrfs-guide](https://christitus.com/btrfs-guide)
(англ.)
> - [https://ctlos.github.io/wiki/btrfs/btrfs-part1](https://ctlos.github.io/wiki/btrfs/btrfs-part1)
{{< /blockquote >}}

#### Монтирование

Если вы выбрали файловую систему ext4, то нужно только смонтировать разделы в
нужные директории. Если у вас файловая система Btrfs, и вы хотите использовать
снимки, нужно сначала создать подразделы:

```sh
mount /dev/sda3 /mnt
btrfs subvolume create /mnt/@
btrfs subvolume list /mnt  # Проверка
umount /mnt
```

Были созданы подразделы в верхнем уровне тома. Эти подразделы можно монтировать
отдельно. В них и будут храниться файлы. Потом можно делать снимки подразделов.

Чтобы смонтировать подраздел, нужно указать опцию монтирования `subvol=путь` или
`subvolid=номер`. Дополнительно можно указать алгоритм сжатия.

```sh
# Опции монтирования: https://btrfs.readthedocs.io/en/latest/Administration.html
mount -o compress=lzo,subvol=@ /dev/sda3 /mnt
mount --mkdir /dev/sda1 /mnt/boot
mount --mkdir /dev/sda4 /mnt/home
```

Аналогично можно создать подразделы для `/home`. Не ошибитесь при монтировании
нужного подраздела в нужную локацию.

### Необходимые пакеты

Перечислите первоначальные пакеты в команде `pacstrap -K /mnt`:

- `base` и `linux` — Необходимые пакеты и ядро системы.
- `linux-firmware` — Прошивка для оборудования (не нужна в виртуальной машине).
- `linux-lts` — Дополнительное ядро с долгосрочной поддержкой на случай, если
что-то случится с основным.
- `intel-ucode` / `amd-ucode` —
[Микрокод](https://wiki.archlinux.org/title/Microcode_(Русский)) (не нужен в
виртуальной машине).
- `btrfs-progs` — Управление файловой системой Btrfs.
- `nano` — Текстовый редактор, который потребуется для редактирования файлов
конфигурации.

### Локализация

Вы можете проследовать официальному руководству, чтобы установить одну локаль в
системе. Если вы хотите видеть интерфейс на языке, отличном от вашей локали, то
нужно дополнительно
[указать переменную LANGUAGE](https://wiki.archlinux.org/title/Locale_(Русский)#LANGUAGE:_запасные_локали):

```conf
# /etc/locale.conf

LANG=ru_RU.UTF-8
LANGUAGE=en_US:en:C:ru_RU
```

В таком случае большинство программ будет отображаться на желаемом языке по
умолчанию.

Примените переменные: `export LANG=ru_RU.UTF-8 LANGUAGE=en_US:en:C:ru_RU`.

В качестве проверки можно ввести `pacman -Syy`. Если дроби в скорости загрузки
отображаются через запятую — установлена русская локаль. Если показываются
русские буквы или квадраты — установлен русский язык (исправить отображение
символов можно командой `setfont cyr-sun16`).

### Сеть

```sh
pacman -S networkmanager
systemctl enable NetworkManager.service
```

### Пользователи

Установите [пароль](https://wiki.archlinux.org/title/Security_(Русский)#Пароли)
для пользователя root, а затем добавьте главного пользователя:

```sh
passwd
useradd -m -g users -G wheel,storage,power -s /usr/bin/bash _username_
passwd _username_
```

Настройте команду `sudo`:

```sh
pacman -S sudo
EDITOR=nano visudo
```

Уберите `#` перед строкой `%wheel ALL=(ALL:ALL) ALL`, чтобы дать себе
возможность пользоваться `sudo`. Для дополнительной безопасности можно добавить
в конце строку `Defaults rootpw`, чтобы вводить пароль root, а не пользователя.

### Загрузчик

[systemd-boot](https://wiki.archlinux.org/title/Systemd-boot) работает только в
EFI (команда `ls /sys/firmware/efi/efivars` должна что-то выводить). Иначе
установите [GRUB](https://wiki.archlinux.org/title/GRUB_(Русский)).

Установите systemd-boot командой `bootctl install`. Если выводит предупреждения
о дырах безопасности (Security hole), то
[установите](https://bbs.archlinux.org/viewtopic.php?id=287695) параметры
`fmask=0077,dmask=0077` для раздела boot в `/etc/fstab`, затем
[смонтируйте заново](https://bbs.archlinux.org/viewtopic.php?pid=2113977#p2113977)
с опциями `uid=0,gid=0,fmask=0077,dmask=0077`.

Создайте опцию в меню загрузчика:

```conf
# /boot/loader/entries/arch.conf

title Arch Linux (linux)
linux /vmlinuz-linux
initrd /initramfs-linux.img
```

Добавьте путь к корневому разделу при помощи команды:

```sh
echo "options root=PARTUUID=$(blkid -s PARTUUID -o value /dev/root) rootflags=subvol=@ rw" >> /boot/loader/entries/arch.conf
```

Обратите внимание на параметр `rootflags=subvol=@` — это подраздел в файловой
системе Btrfs. Если его не установить или установить неправильно, то система не
загрузится должным образом. В файловой системе ext4 такой опции не требуется.

После `rw` через пробел перечисляются параметры ядра.

Добавьте опции загрузки других ядер (linux-lts):

```sh
cp /boot/loader/entries/arch.conf /boot/loader/entries/arch-lts.conf
nano /boot/loader/entries/arch-lts.conf
# title Arch Linux (linux-lts)
# linux /vmlinuz-linux-lts
# initrd /initramfs-linux-lts.img
```

Также можно настроить загрузчик, чтобы указать таймаут перед загрузкой:
`nano /boot/loader/loader.conf`.

### Перезагрузка

```sh
exit
umount -R /mnt
reboot
```

Должна быть установлена загрузка с диска, но вы можете извлечь загрузочное
устройство на этом этапе.

Если вы всё сделали правильно, то система должна загрузиться и пригласить вас
ввести логин и пароль. Авторизуйтесь под своим пользователем или root и
установите графическую среду, программы и важные компоненты.

> **Смотрите также:**
[Основные рекомендации — ArchWiki](https://wiki.archlinux.org/title/General_recommendations_(Русский))
{.related}

### NVIDIA

Установите проприетарные драйверы NVIDIA, следуя руководствам:

- [Только NVIDIA](https://wiki.archlinux.org/title/NVIDIA_(Русский))
- [Гибридная графика](https://wiki.archlinux.org/title/NVIDIA_Optimus_(Русский))

Перед установкой может потребоваться установить пакет `linux-headers`
(и `linux-lts-headers` для LTS-ядра).

Для гибридной графики (на ноутбуках) требуется установить `nvidia-prime`.
После установки работоспособность можно проверить командой
`prime-run glxinfo | grep "OpenGL renderer"`.

### Рабочий стол

> **Смотрите также:**
[Среды рабочего стола](https://wiki.archlinux.org/title/Desktop_environment_(Русский)),
[Сравнение рабочих столов](https://wiki.archlinux.org/title/Comparison_of_desktop_environments_(Русский))
— Arch Wiki
{.related}

Установите нужные пакеты, перечислив их в `pacman -S`, и удалите ненужные при
помощи `pacman -Rns`.

Стоит установить [важные пакеты](#пакеты).

#### KDE Plasma

> **Смотрите также:**
[Рекомендации по установке KDE](https://community.kde.org/Distributions/Packaging_Recommendations)
(англ.)
{.related}

Основные:
- `plasma-meta` / `plasma` — Рабочий стол.
[Разница между мета-пакетом и группой пакетов](https://wiki.archlinux.org/title/Meta_package_and_package_group_(Русский))
- `konsole` — Эмулятор терминала
- `dolphin` — Файловый менеджер
- `ark` — Управление архивами
- `kate` / `kwrite` — Среда разработки / Текстовый редактор
- `spectacle` — Создание снимков экрана
- `kdeconnect` — Связь телефона и компьютера

Важные компоненты:
- `qt6-imageformats` — отображение изображений WEBP и других форматов
- `ffmpegthumbs` — рендер обложек видео в файловом менеджере
- `dolphin-plugins` — плагины для файлового менеджера Dolphin
(интеграция с Git, монтирование ISO)
- `xdg-desktop-portal-gtk` — корректное отображение программ из Flatpak
- `flatpak-kcm` — Меню прав приложений в параметрах системы
- `print-manager` — Управление принтерами
- `markdownpart` — Рендер Markdown в Kate
- `qt6-quick3d` — Эффект куба

Ненужные (можно удалить только если вы устанавливали `plasma`, а не
`plasma-meta`):
- `plasma-vault` — зашифрованные папки
(можно использовать [VeraCrypt](/wiki/veracrypt) вместо этого)
- `oxygen`, `oxygen-sounds` — старая тема

Чтобы использовать окно выбора файлов KDE в Firefox, установите параметр
`widget.use-xdg-desktop-portal.file-picker=1` в `about:config`.

Когда будете готовы, включите службу SDDM и перезагрузите компьютер:

```sh
systemctl enable sddm.service
reboot
```

{{< blockquote >}}
> [!important]
> Для работы сеанса Wayland в VirtualBox требуется включить 3D-ускорение в
настройках машины.
{{< /blockquote >}}

#### Пользовательские директории

Можно переименовать
[пользовательские директории](https://wiki.archlinux.org/title/XDG_user_directories_(Русский))
"Загрузки", "Рабочий стол" и другие:

{{< blockquote >}}
> [!important]
> Войдите под учётной записью вашего пользователя, прежде чем менять директории.
{{< /blockquote >}}

```sh
xdg-user-dirs-update --set DOWNLOAD ~/download
xdg-user-dirs-update --set PICTURES ~/pic
# ...
mkdir ~/download
mkdir ~/pic
# ...
xdg-user-dirs-update  # Создаст папки
ls ~  # Удалите лишние папки при помощи rm -r
```

## Конфигурация

Вы можете настроить систему во время или после установки.

> **Смотрите также:** [Конфигурация Pacman](#конфигурация-1)
{.related}

### Микрокод

Стоит установить
[микрокод](https://wiki.archlinux.org/title/Microcode_(Русский)), чтобы
получать патчи безопасности и стабильности:

```sh
grep vendor /proc/cpuinfo  # Информация о производителе

pacman -S intel-ucode  # Для процессоров Intel
pacman -S amd-ucode  # Для процессоров AMD

sudo dmesg | grep 'microcode:'  # Проверить, загружен ли микрокод
```

### Оптимизация SSD

Если у вас есть SSD, то включите
[периодический TRIM](https://wiki.archlinux.org/title/Solid_state_drive_(Русский)#TRIM)

Сначала проверьте поддержку командой `lsblk --discard`. Если значения DISC-GRAN
и DISC-MAX не нулевые, то диск поддерживает TRIM.
**Не используйте TRIM, если он не поддерживается.**

Затем включите таймер: `systemctl enable fstrim.timer`.

### Firewall

```sh
sudo pacman -S ufw
sudo systemctl enable ufw.service
sudo systemctl start ufw.service
sudo ufw enable
sudo ufw status
```

Для работы KDE Connect нужно разрешить порты:

```sh
sudo ufw allow 1714:1764/udp
sudo ufw allow 1714:1764/tcp
```

## ArchWiki

[ArchWiki](https://wiki.archlinux.org/title/ArchWiki:About_(Русский)) — главный
ресурс для получения информации в основном про Arch Linux, но он также может
быть полезен и для других дистрибутивов. В случае возникновения каких-либо
проблем или необходимости получения справки, стоит проверять ArchWiki. Это самый
богатый ресурс, который создаётся сообществом.

Список интересных страниц для ознакомления:
- [Основные рекомендации](https://wiki.archlinux.org/title/General_recommendations_(Русский))
- [Обслуживание системы](https://wiki.archlinux.org/title/System_maintenance_(Русский))
- [Устранение неполадок в системе](https://wiki.archlinux.org/title/General_troubleshooting_(Русский))
- [Улучшение производительности](https://wiki.archlinux.org/title/Improving_performance_(Русский))
- [Безопасность](https://wiki.archlinux.org/title/Security_(Русский))
- [Расширения для браузеров](https://wiki.archlinux.org/title/Browser_extensions_(Русский))
- [Ноутбук](https://wiki.archlinux.org/title/Laptop) (англ.)
- [Игры](https://wiki.archlinux.org/title/Gaming) (англ.)
- [Исправление проблем в определённых играх](https://wiki.archlinux.org/title/Steam/Game-specific_troubleshooting) (англ.)
- [Dotfiles](https://wiki.archlinux.org/title/Dotfiles) (англ.)
- [ASCII-арт](https://wiki.archlinux.org/title/ASCII_art) (англ.)

## Обслуживание системы

> **Смотрите также:**
[Обслуживание системы — ArchWiki](https://wiki.archlinux.org/title/System_maintenance_(Русский))
{.related}

Вы должны регулярно обновлять систему командой `sudo pacman -Syu`. Частичные
обновления могут сломать систему — всегда обновляйте полностью. Перед тем, как
сообщать о проблемах, система должна быть полностью обновлена. Рекомендуется
перезагружать компьютер после обновления.

### Исправление проблем

> **Смотрите также:**
[Устранение неполадок в системе — ArchWiki](https://wiki.archlinux.org/title/General_troubleshooting_(Русский))
{.related}

- Смотрите журнал системы:
    - `sudo journalctl -b` — Текущий сеанс
    - `sudo journalctl -b-1` — Предыдущий сеанс (цифра указывает количество
    сеансов назад)
    - `sudo journalctl -b-1 > logs.txt` — Записать журнал в файл
- Проверяйте ошибки в службах: `systemctl --failed`
- Сколько времени заняло выполнение служб: `systemd-analyze blame`

### Снимки системы

Настройте автоматическое создание снимков системы для возможности восстановления
в случае неудачных обновлений или изменений конфигурации.

Файловая система Btrfs позволяет создавать снимки раздела моментально с
минимальной затратой места на диске.

#### Timeshift

[Timeshift](https://wiki.archlinux.org/title/Timeshift) — графическая программа
для создания автоматических снимков системы. Поддерживаются режимы Btrfs для
соответствующей файловой системы, и Rsync для других.

```sh
sudo pacman -S timeshift
# Запустите Timeshift и завершите настройку.

# Включите эту службу, иначе периодическое создание снимков не будет работать.
sudo systemctl enable cronie.service
sudo systemctl start cronie.service

# Проверить список снимков для Btrfs
sudo btrfs subvolume list /  # /home
```

## Pacman

### Использование

- `sudo pacman -Syu` — Обновить все системные пакеты. Рекомендуется обновлять
регулярно и перезагружать компьютер после этого.
- `sudo pacman -Rns` — Удалить пакеты со всеми зависимостями, при возможности
очистив данные.
- `pacman -Ss` — Поиск пакетов
- `pacman -Qtd` — Список неиспользуемых пакетов.
- `pacman -Qm` — Список пакетов не из официальных репозиториев (AUR).

### Графический интерфейс

Можно обновлять пакеты через
[графический интерфейс](https://wiki.archlinux.org/title/Pacman_(Русский)/Tips_and_tricks_(Русский)#Графические)
(например, `discover` или `gnome-software`), если установить `packagekit`
(и `packagekit-qt6`). Однако это не рекомендуется, так как могут возникнуть
проблемы. Через консольный интерфейс можно увидеть ошибки и предупреждения,
которые можно вовремя исправить.

Графический интерфейс центра приложений лучше подходит для пакетов Flatpak.

### Пакеты

Здесь будут перечислены пакеты, которые обычно не устанавливаются по умолчанию,
но их отсутствие приводит к утрате функциональности системы.

#### Компоненты

- `ntfs-3g`, `exfat-utils` — Управление дополнительными файловыми системами
- `unrar` — Разархивация RAR
- `cups` — Служба печати [CUPS](https://wiki.archlinux.org/title/CUPS_(Русский))
(`systemctl enable cups.service && systemctl start cups.service`)
- `power-profiles-daemon` — Профили энергопотребления для ноутбука
- `aspell-en`, `aspell-ru` — Проверка орфографии
- `noto-fonts-emoji` — Эмодзи
- `tk` — Tkinter для Python
- `base-devel` — Пакеты для сборки программ из исходного кода

#### Инструменты

- `man-db` — Документация (команда `man`)
- `less` — Более удобное чтение текста в терминале
(`less /proc/cpuinfo` или `cat /proc/cpuinfo | less`)
- `grep` — Поиск в тексте
(`grep "model name" /proc/cpuinfo` или `cat /proc/cpuinfo | grep "model name"`)
- `neofetch` — Информация о системе в терминале
- `htop` / `btop` — Системный монитор в терминале
- `lshw` — Информация об оборудовании
- `flatpak` — Пакетный менеджер [Flatpak](https://wiki.archlinux.org/title/Flatpak)
- `git` — Система контроля версий для работы с исходным кодом программ
- [Языковые серверы](https://wiki.archlinux.org/title/Language_Server_Protocol)
для Kate, Neovim

Вы можете использовать Flatpak для установки графических программ: браузер,
офис, утилиты, мессенджеры — все они доступны во [Flathub](https://flathub.org).
Пакеты Flatpak находятся в песочнице и не устанавливаются как системные
компоненты, что может повысить стабильность системы, особенно если заменить ими
пакеты из AUR. Некоторые разработчики официально распространяют свои программы
во Flathub, и они доступны во всех дистрибутивах. Иногда можно столкнуться с
проблемами: некорректная тема, отсутствие разрешений, трата места на диске. Для
управления разрешениями можно использовать
[Flatseal](https://flathub.org/apps/com.github.tchx84.Flatseal) или меню
параметров системы `flatpak-kcm` в KDE Plasma. Получать обновления можно либо
через приложение `discover` или `gnome-software`, либо через терминал
`flatpak upgrade`.

### Конфигурация

Файл конфигурации — `/etc/pacman.conf`.

Уберите `#` перед строками:
- `Color` — Включает цвета
- `ParallelDownloads` — Включает параллельное скачивание, можно указать
количество потоков.

Добавьте строку `ILoveCandy`, чтобы изменить стиль полосы прогресса скачивания.

Проверить изменения можно командой `pacman -Syy`.

### Репозитории

Чтобы включить другие репозитории, нужно убрать `#` перед названием репозитория
и 'Include' под ним:

```conf
# /etc/pacman.conf

[multilib]
Include = /etc/pacman.d/mirrorlist
```

multilib — репозиторий с 32-битными программами. Включите его, чтобы иметь
возможность установить Wine и Steam.

Также есть репозитории *-testing, в которых тестируются новые версии пакетов.
Они сделают систему более нестабильной, но дадут попробовать новейшее
программное обеспечение.

После изменения включённых репозиториев нужно обновить систему.

### Обновление списка зеркал

```sh
sudo pacman -S reflector

# Сделайте резервную копию текущего списка
sudo cp /etc/pacman.d/mirrorlist /etc/pacman.d/mirrorlist.bak

sudo reflector --verbose --country 'Germany,Russia,' --latest 20 \
--protocol https --sort rate --save /etc/pacman.d/mirrorlist
```

Включите службу и таймер для автоматического обновления зеркал. Перед этим
настройте конфигурацию Reflector:

```sh
sudo nano /etc/xdg/reflector/reflector.conf
sudo systemctl enable reflector.service
sudo systemctl enable reflector.timer
sudo systemctl start reflector.timer
```

### Очистка кэша

> **Основная статья:**
[Pacman — Очистка кэша пакетов — ArchWiki](https://wiki.archlinux.org/title/Pacman_(Русский)#Очистка_кэша_пакетов)
{.related}

При обновлении и установке пакетов Pacman сохраняет старые версии для
возможности быстрого отката. Настройте автоматическое удаление старых архивов
каждую неделю:

```sh
sudo pacman -S pacman-contrib
sudo systemctl enable paccache.timer
sudo systemctl start paccache.timer
```

Также можно очищать кэш вручную. `sudo pacman -Sc` удалит кэш неустановленных
пакетов, а `sudo pacman -Scc` удалит весь кэш. Последнюю команду не
рекомендуется выполнять, если нет крайней необходимости освободить место на
диске.

### Arch User Repository

> **Основная статья:**
[Arch User Repository — ArchWiki](https://wiki.archlinux.org/title/Arch_User_Repository_(Русский))
{.related}

В [пользовательском репозитории](https://aur.archlinux.org) (AUR) можно найти
практически любую программу. Это хоть и удобно, но добавляет риски безопасности
и поломки системы, поскольку эти пакеты официально не поддерживаются.
Большинство пакетов из AUR компилируются (если не оканчиваются на -bin). Также
можно найти программы последней нестабильной редакции (оканчиваются на -git).

Чтобы легко устанавливать и обновлять пакеты из AUR, установите помощник,
например, `yay` или `paru`:

```sh
sudo pacman -S --needed git base-devel
git clone https://aur.archlinux.org/yay
cd yay
makepkg -sric

yay librewolf  # Поиск пакетов
yay -S librewolf-bin  # Установка из AUR
```

При установке или обновлении из AUR вам предложат показать изменения
(Show Diffs) — это покажет изменения в файле PKGBUILD, который является
"рецептом" сборки пакета. Рекомендуется проверять его содержимое, чтобы не
допустить запуск вредоносного кода.

`yay` также можно использовать в качестве обёртки для `pacman`:

```sh
yay firefox  # Поиск пакетов
yay -S firefox  # Установка пакетов из официальных репозиториев
yay  # Обновление системы (sudo pacman -Syu)
```

### Новости

[На официальном сайте](https://archlinux.org/news) иногда появляются новости,
которые всегда требуют внимания. Это могут быть изменения в пакетах. Чтобы не
сломать систему, нужно получать новости перед выполнением обновлений. Эту задачу
решает Informant (AUR).

```sh
yay -S informant
yay
sudo informant read
```

## Благодарности

В этом разделе будут перечислены ссылки на источники, из которых была взята
значительная часть информации на этой странице. Вы можете ознакомиться с ними
для получения дополнительной информации.

- [ARU — Руководство по оптимизации Arch Linux](https://ventureo.codeberg.page)

Видео:

- [I Installed The Hardest System Known To Man... — SomeOrdinaryGamers](https://youtu.be/_JYIAaLrwcY)
- [The Foundation — EF - Linux Made Simple](https://youtu.be/hdJX27g0z14)
- [10 Things You MUST DO After Installing Arch Linux (2023) — Ksk Royal](https://youtu.be/odgD_RdJjCU)
